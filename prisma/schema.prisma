generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?
  firstName String
  lastName  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  accounts Account[]
}

model Company {
  id        String   @id @default(cuid())
  name      String
  image     String?
  phone     String?
  createdAt DateTime @default(now())

  users   User[]
  raffles Raffle[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
}

model Raffle {
  id          String  @id @default(cuid())
  title       String
  description String  @db.Text
  image       String?

  totalNumbers Int
  numberPrice  Decimal @db.Decimal(10, 2)

  hasQuantityDiscount Boolean @default(false)

  drawMethod  DrawMethod
  drawDate    DateTime?
  drawTrigger DrawTrigger

  status RaffleStatus @default(DRAFT)

  winnerNumber Int?
  winnerName   String?
  winnerPhone  String?
  winnerEmail  String?
  drawnAt      DateTime?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  quantityDiscounts QuantityDiscount[]
  payments          Payment[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  publishedAt DateTime?
  finishedAt  DateTime?
  soldNumbers SoldNumber[]

  @@index([companyId])
  @@index([status])
}

model QuantityDiscount {
  id         String  @id @default(cuid())
  quantity   Int
  percentage Decimal @db.Decimal(5, 2)

  raffleId String
  raffle   Raffle @relation(fields: [raffleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([raffleId, quantity])
  @@index([raffleId])
}

model Payment {
  id String @id @default(cuid())

  amount   Decimal       @db.Decimal(10, 2)
  currency String        @default("ARS")
  status   PaymentStatus @default(PENDING)

  provider          PaymentProvider @default(MERCADO_PAGO)
  providerPaymentId String?         @unique

  providerMetadata Json?

  paymentType PaymentType

  raffleId String
  raffle   Raffle? @relation(fields: [raffleId], references: [id], onDelete: Cascade)

  soldNumbers SoldNumber[]

  payerName      String?
  payerEmail     String?
  payerPhone     String?
  payerInstagram String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?

  @@index([status])
  @@index([providerPaymentId])
  @@index([raffleId])
}

model SoldNumber {
  id String @id @default(cuid())

  number    Int
  raffleId  String
  paymentId String

  raffle  Raffle  @relation(fields: [raffleId], references: [id])
  payment Payment @relation(fields: [paymentId], references: [id])

  @@unique([raffleId, number])
}

enum DrawMethod {
  QUINIELA_NACIONAL
  ALEATORIO
}

enum DrawTrigger {
  VENDER_TODO
  FECHA_FIJA
}

enum RaffleStatus {
  DRAFT
  ACTIVE
  FINISHED
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PaymentProvider {
  MERCADO_PAGO
  MANUAL
}

enum PaymentType {
  RAFFLE_ACTIVATION
  NUMBER_PURCHASE
}
